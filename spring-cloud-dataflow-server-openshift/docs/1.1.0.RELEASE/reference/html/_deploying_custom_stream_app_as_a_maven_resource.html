<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>15.&nbsp;Deploying Custom Stream App as a Maven Resource</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Cloud Data Flow Server for OpenShift"><link rel="up" href="howto.html" title="Part&nbsp;VIII.&nbsp;&#8216;How-to&#8217; guides"><link rel="prev" href="howto.html" title="Part&nbsp;VIII.&nbsp;&#8216;How-to&#8217; guides"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">15.&nbsp;Deploying Custom Stream App as a Maven Resource</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="howto.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;VIII.&nbsp;&#8216;How-to&#8217; guides</th><td width="20%" align="right">&nbsp;</td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_deploying_custom_stream_app_as_a_maven_resource" href="#_deploying_custom_stream_app_as_a_maven_resource"></a>15.&nbsp;Deploying Custom Stream App as a Maven Resource</h2></div></div></div><p>This section walks you through deploying a simple Spring Cloud Stream based application, packaged as a Maven artifact, to OpenShift.
The source code for this app is available in the following <a class="link" href="https://github.com/donovanmuller/timezone-processor-kafka" target="_top">GitHub repository</a>.</p><p>This guide assumes that you have gone through the <a class="xref" href="getting-started.html" title="Part&nbsp;III.&nbsp;Getting Started">Part&nbsp;III, &#8220;Getting Started&#8221;</a> section and are using a local minishift
instance of OpenShift. Adjust the steps accordingly if you are using an existing OpenShift cluster.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploy_a_nexus_repository" href="#_deploy_a_nexus_repository"></a>15.1&nbsp;Deploy a Nexus Repository</h2></div></div></div><p>For OpenShift to build the Docker image that will be deployed, it must be able to resolve and download the custom app&#8217;s Jar artifact.
This means that the custom app must be deployed to an accessible Maven repository.</p><p>Assuming the local minishift OpenShift environment discussed in the <a class="xref" href="getting-started.html" title="Part&nbsp;III.&nbsp;Getting Started">Part&nbsp;III, &#8220;Getting Started&#8221;</a> section, we will deploy
a Nexus container to which we can deploy our custom application. Deploying the Nexus image is trivial thanks to
an OpenShift template <a class="link" href="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/v1.1.0.RELEASE/src/etc/openshift/nexus-template.yaml" target="_top">available here</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Make sure you have configured the <code class="literal">scdf</code> Service Account mentioned in the <a class="xref" href="getting-started.html" title="Part&nbsp;III.&nbsp;Getting Started">Part&nbsp;III, &#8220;Getting Started&#8221;</a> section, as this account is
used by the Nexus deployment.</p></td></tr></table></div><p>Using the <code class="literal">oc</code> tool, upload the Nexus template with:</p><pre class="programlisting">$ oc create -f https://raw.githubusercontent.com/donovanmuller/spring-cloud-dataflow-server-openshift/v1.1.0.RELEASE/src/etc/openshift/nexus-template.yaml
...</pre><p>Once uploaded, open the OpenShift Console (you can use <code class="literal">minishift console</code>), authenticate and navigate to the <code class="literal">scdf</code> project.
Then click <span class="emphasis"><em>Add to Project</em></span> and select the <code class="literal">nexus</code> template:</p><div class="informalfigure"><div class="mediaobject"><img src="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/raw/master/spring-cloud-dataflow-server-openshift-docs/src/main/asciidoc/images/scdf-openshift-nexus-template.png" alt="Data Flow Server template"></div></div><p>The default configurations should be sane. However, you must provide the <span class="strong"><strong>The OpenShift Route host value</strong></span>.
This value will depend on your minishift and OpenShift Router environment but should be similar to
<code class="literal">nexus-scdf.192.168.64.15.xip.io</code>. Where <code class="literal">-scdf.192.168.64.15.xip.io</code> is the project name (<code class="literal">scdf</code>) and
the default routing subdomain (<code class="literal">192.168.64.15.xip.io</code>).</p><div class="informalfigure"><div class="mediaobject"><img src="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/raw/master/spring-cloud-dataflow-server-openshift-docs/src/main/asciidoc/images/scdf-openshift-nexus-route.png" alt="Data Flow Server route configuration"></div></div><p>Click <span class="emphasis"><em>Create</em></span> when you&#8217;re happy with the configuration.
Wait for the Nexus image to be pulled and the deployment to be successful. Once the Pod has been scaled successfully
you should be able to access the Nexus UI by clicking on the Route URL (<a class="link" href="http://nexus-scdf.192.168.64.15.xip.io" target="_top">nexus-scdf.192.168.64.15.xip.io</a> in this example).</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The default credential for Nexus is <code class="literal">admin</code>/<code class="literal">admin123</code> or <code class="literal">deployment</code>/<code class="literal">deployment123</code></p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configuring_the_data_flow_server_for_openshift" href="#_configuring_the_data_flow_server_for_openshift"></a>15.2&nbsp;Configuring the Data Flow Server for OpenShift</h2></div></div></div><p>We need to configure the Data Flow Server to use this new Nexus instance as a remote Maven repository.
If you have an existing deployment from the <a class="xref" href="getting-started.html" title="Part&nbsp;III.&nbsp;Getting Started">Part&nbsp;III, &#8220;Getting Started&#8221;</a> section you will have to change it&#8217;s configuration.</p><p>There are a few ways to do that but the way described here is to remove the existing deployment and use the
existing <a class="link" href="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/v1.1.0.RELEASE/src/etc/openshift/scdf-ephemeral-datasources-kafka-template.yaml" target="_top">Data Flow Server with ephemeral Datasources and Kafka binder</a> template
to deploy the updated configuration.</p><p>Remove the current environment using the <code class="literal">oc</code> tool (assuming you used the Kafka template):</p><pre class="programlisting">$ oc delete all --selector=template=scdf-kafka
$ oc delete cm --selector=template=scdf-kafka
$ oc delete secret --selector=template=scdf-kafka</pre><p>Next click <span class="emphasis"><em>Add to Project</em></span> and select the <code class="literal">spring-cloud-dataflow-server-openshift-ephemeral-kafka</code> template.
Use the following values for the Maven configuration items:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Configuration Parameter</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Remote Maven repository name</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>nexus</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Remote Maven repository URL</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://nexus-scdf.192.168.64.15.xip.io/content/groups/public" target="_top">nexus-scdf.192.168.64.15.xip.io/content/groups/public</a> (use your Route URL for Nexus here)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Remote Maven repository username</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>deployment</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Remote Maven repository password</p></td><td style="" align="left" valign="top"><p>deployment123</p></td></tr></tbody></table></div><div class="informalfigure"><div class="mediaobject"><img src="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/raw/master/spring-cloud-dataflow-server-openshift-docs/src/main/asciidoc/images/scdf-openshift-maven.png" alt="Data Flow Server Maven configuration"></div></div><p>Click <span class="emphasis"><em>Create</em></span> and wait for the deployment to complete successfully.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_cloning_and_deploying_the_app" href="#_cloning_and_deploying_the_app"></a>15.3&nbsp;Cloning and Deploying the App</h2></div></div></div><p>Next step is to deploy our custom app into the Nexus instance.
First though, we need to clone the custom app source.</p><pre class="programlisting">$ git clone https://github.com/donovanmuller/timezone-processor-kafka.git
$ cd timezone-processor-kafka</pre><p>Next we deploy the application into our Nexus repository with</p><pre class="programlisting">$ ./mvnw -s .settings.xml deploy -Dnexus.url=http://nexus-scdf.192.168.64.15.xip.io/content/repositories/snapshots
...
Uploading: http://nexus-scdf.192.168.64.15.xip.io/content/repositories/snapshots/io/switchbit/timezone-processor-kafka/maven-metadata.xml
Uploaded: http://nexus-scdf.192.168.64.15.xip.io/content/repositories/snapshots/io/switchbit/timezone-processor-kafka/maven-metadata.xml (294 B at 6.0 KB/sec)
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 13.156 s
[INFO] Finished at: 2016-11-30T20:42:54+02:00
[INFO] Final Memory: 35M/302M
[INFO] ------------------------------------------------------------------------</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Substitute the value for <code class="literal">-Dnexus.url</code> with the URL matching your Nexus instance.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_the_stream" href="#_deploying_the_stream"></a>15.4&nbsp;Deploying the Stream</h2></div></div></div><p>Now that our custom app is ready, let&#8217;s register it with the Data Flow Server.
Using the Data Flow Shell, targeted to our OpenShift deployed instance, register the <code class="literal">timezone</code> app with:</p><pre class="programlisting">dataflow:&gt;app register --name timezone --type processor --uri maven://io.switchbit:timezone-processor-kafka:1.0-SNAPSHOT
Successfully registered application 'processor:timezone'</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The assumption is that the out-of-the-box apps have been imported previously as part of the <a class="xref" href="getting-started.html" title="Part&nbsp;III.&nbsp;Getting Started">Part&nbsp;III, &#8220;Getting Started&#8221;</a> section.
If the apps are not imported, import them now with:</p><pre class="programlisting">dataflow:&gt;app import --uri http://bit.ly/stream-applications-kafka-docker</pre><p>It does not really matter whether the Docker or Maven out-of-the-box apps are registered.</p></td></tr></table></div><p>Now we can define a stream using our timezone processor with:</p><pre class="programlisting">dataflow:&gt;stream create --name timezoney --definition "time | timezone | log"
Created new stream 'timezoney'</pre><p>and deploy it with:</p><pre class="programlisting">dataflow:&gt;stream deploy timezoney --properties "app.timezone.timezone=Africa/Johannesburg,app.timezone.spring.cloud.deployer.openshift.defaultDockerfile=Dockerfile.nexus"
Deployment request has been sent for stream 'timezoney'</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>We provide two deployment properties to the <code class="literal">timezone</code> app. The first is the required timezone to convert the input times.
The second is to inform the Data Flow Server that it should use the provided default Dockerfile (<code class="literal">Dockerfile.nexus</code>) that supports Nexus repositories,
instead of the default <code class="literal">Docker.artifactory</code>.</p></td></tr></table></div><p>You should see a build being triggered for the <code class="literal">timezone</code> app, which will download the <code class="literal">timezone-processor-kafka</code>
Maven artifact from the Nexus repository and build the Docker image. Once the build is successful, the app will be deployed
alongside the other apps.</p><div class="informalfigure"><div class="mediaobject"><img src="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/raw/master/spring-cloud-dataflow-server-openshift-docs/src/main/asciidoc/images/scdf-openshift-custom-app-deployed.png" alt="timezoney stream deployed"></div></div><p>View both the <code class="literal">timezoney-timezone-0</code> and <code class="literal">timezoney-log-0</code> apps for the expected log outputs.</p><div class="informalfigure"><div class="mediaobject"><img src="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/raw/master/spring-cloud-dataflow-server-openshift-docs/src/main/asciidoc/images/scdf-openshift-custom-app-timezone.png" alt="timezoney stream logs"></div></div><div class="informalfigure"><div class="mediaobject"><img src="https://github.com/donovanmuller/spring-cloud-dataflow-server-openshift/raw/master/spring-cloud-dataflow-server-openshift-docs/src/main/asciidoc/images/scdf-openshift-custom-app-log.png" alt="timezoney stream logs"></div></div><p>Once you&#8217;re done, destroy the stream with:</p><pre class="programlisting">dataflow:&gt;stream destroy timezoney
Destroyed stream 'timezoney'</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="howto.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="howto.html">Up</a></td><td width="40%" align="right">&nbsp;</td></tr><tr><td width="40%" align="left" valign="top">Part&nbsp;VIII.&nbsp;&#8216;How-to&#8217; guides&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;</td></tr></table></div></body></html>